name: Generate Sitemap

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sitemap:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Run Python Sitemap Generator
        run: |
          python3 - <<EOF
          import os
          from datetime import datetime

          SITE_URL = "https://www.vetcardiohub.com"
          # UPDATED: Pointing to your actual directory
          BLOG_DIR = "./blog-posts" 
          OUTPUT_FILE = "sitemap.xml"

          urls = []
          # Home, About, Videos, Blog (The main listing page)
          static_pages = [
              ("", "1.0"),
              ("about.html", "0.8"),
              ("videos.html", "0.9"),
              ("blog.html", "0.8")
          ]

          print(f"Starting sitemap generation...")

          # 1. Process Static Pages
          for page, priority in static_pages:
              clean_url = f"{SITE_URL}/{page}" if page else SITE_URL
              urls.append(f"  <url>\n    <loc>{clean_url}</loc>\n    <lastmod>{datetime.today().date()}</lastmod>\n    <priority>{priority}</priority>\n  </url>")

          # 2. Process Blog Posts (Recursive Search)
          if os.path.exists(BLOG_DIR):
              print(f"Found {BLOG_DIR} folder. Searching for posts...")
              for root, dirs, files in os.walk(BLOG_DIR):
                  for filename in files:
                      if filename.endswith(".html"):
                          # Calculate the path relative to the blog-posts folder
                          relative_path = os.path.relpath(os.path.join(root, filename), BLOG_DIR)
                          
                          # This creates: https://www.vetcardiohub.com/blog-posts/your-post.html
                          full_url = f"{SITE_URL}/blog-posts/{relative_path}"
                          
                          path = os.path.join(root, filename)
                          lastmod = datetime.fromtimestamp(os.path.getmtime(path)).date()
                          
                          print(f"Adding: {full_url}")
                          urls.append(f"  <url>\n    <loc>{full_url}</loc>\n    <lastmod>{lastmod}</lastmod>\n    <priority>0.7</priority>\n  </url>")
          else:
              print(f"ERROR: {BLOG_DIR} directory not found!")

          sitemap_content = '<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n'
          sitemap_content += "\n".join(urls)
          sitemap_content += "\n</urlset>"

          with open(OUTPUT_FILE, "w") as f:
              f.write(sitemap_content)
          print(f"Sitemap successfully written to {OUTPUT_FILE}")
          EOF

      - name: Commit sitemap
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if [ -f sitemap.xml ]; then
            git add sitemap.xml
            git diff --cached --quiet || (git commit -m "Auto-update sitemap" && git push)
          else
            echo "sitemap.xml not found"
            exit 1
          fi
