name: Generate Sitemap

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sitemap:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Generate sitemap
        run: |
          python3 - <<EOF
          import os
          from datetime import datetime

          SITE_URL = "https://www.vetcardiohub.com"
          BLOG_DIR = "./blog-posts"
          OUTPUT_FILE = "sitemap.xml"

          EXCLUDE_FILES = ["404.html"]

          urls = {}
          today = datetime.today().date()

          def build_url(path):
              if path == "index.html":
                  return SITE_URL
              elif path.endswith(".html"):
                  clean_path = path.replace("\\\\", "/")
                  return f"{SITE_URL}/{clean_path.replace('.html','')}"
              return None

          print("Starting sitemap generation...")

          # 1️⃣ Root-level pages
          for filename in os.listdir("."):
              if filename.endswith(".html") and filename not in EXCLUDE_FILES:
                  url = build_url(filename)
                  if url:
                      lastmod = datetime.fromtimestamp(os.path.getmtime(filename)).date()
                      priority = "1.0" if filename == "index.html" else "0.8"
                      urls[url] = (lastmod, priority)
                      print(f"Added root page: {url}")

          # 2️⃣ Blog posts (recursive)
          if os.path.exists(BLOG_DIR):
              for root, dirs, files in os.walk(BLOG_DIR):
                  for filename in files:
                      if filename.endswith(".html"):
                          full_path = os.path.join(root, filename)
                          relative_path = os.path.relpath(full_path, ".")
                          url = build_url(relative_path)
                          if url:
                              lastmod = datetime.fromtimestamp(os.path.getmtime(full_path)).date()
                              urls[url] = (lastmod, "0.7")
                              print(f"Added blog post: {url}")
          else:
              print(f"Warning: {BLOG_DIR} not found.")

          # 3️⃣ Sort URLs alphabetically
          sorted_urls = sorted(urls.items(), key=lambda x: x[0])

          # 4️⃣ Build sitemap XML
          sitemap_content = '<?xml version="1.0" encoding="UTF-8"?>\\n'
          sitemap_content += '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\\n'

          for url, (lastmod, priority) in sorted_urls:
              sitemap_content += f"""  <url>
            <loc>{url}</loc>
            <lastmod>{lastmod}</lastmod>
            <priority>{priority}</priority>
          </url>
          """

          sitemap_content += "</urlset>"

          with open(OUTPUT_FILE, "w") as f:
              f.write(sitemap_content)

          print(f"Sitemap successfully written to {OUTPUT_FILE}")
          EOF

      - name: Commit sitemap
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if [ -f sitemap.xml ]; then
            git add sitemap.xml
            git diff --cached --quiet || (git commit -m "Auto-update sitemap" && git push)
          else
            echo "sitemap.xml not found"
            exit 1
          fi
